<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Retro Mobile Controller Overlay</title>
<style>
  :root{
    --scale: 1;
    --gap: calc(10px * var(--scale));
    --pad: calc(12px * var(--scale));
    --dpad: calc(400px * var(--scale));
    --btn: calc(150px * var(--scale));
    --btn-lg: calc(150px * var(--scale));
    --pill-w: calc(170px * var(--scale));
    --pill-h: calc(88px * var(--scale));
    --shadow-outer: 0 14px 22px rgba(0,0,0,.35);
    --shadow-press: 0 6px 0 rgba(0,0,0,.45), 0 6px 12px rgba(0,0,0,.35) inset;
    --shine: radial-gradient(120% 120% at 28% 22%, rgba(255,255,255,.65) 0, rgba(255,255,255,0) 45%);
    --red1:#ff6767; --red2:#d63a3a;
    --blue1:#b8d6ff; --blue2:#5d94ff;
    --metal2:#bdbdbd;
    /* New theme accents for minimalist insets */
    --inset-fill: rgba(255,255,255,.12);
    --inset-stroke: rgba(0,0,0,.05);
    --inset-glow: rgba(255,255,255,.35);
  }
  html, body { margin:0; height:100%; background:black; -webkit-tap-highlight-color: transparent; }
  * { box-sizing: border-box; }
  [hidden] { display: none !important; }

  /* ===== FAB ===== */
  .fab {
    position: fixed; right: 18px; bottom: 18px;
    z-index: 2147483600;
    border: solid 2px white; 
    cursor: pointer;
    padding: 14px 20px;
    border-radius: 999px;
    font: 800 14px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    letter-spacing: .6px;
    background:transparent;
    color: white;
    transition: transform .08s ease, box-shadow .12s ease, filter .12s ease;
    user-select:none;
  }
  .fab:hover { filter: brightness(1.03); }
  .fab:active { transform: translateY(1px); box-shadow: 0 8px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.4); }

  /* ===== Controller Overlay ===== */
  .controller {
    position: fixed; inset: 0; z-index: 2147483646;
    background: transparent;
    pointer-events: none;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    grid-template-rows: 1fr auto;
    align-items: end;
    padding: clamp(8px, 3.2vw, 24px);
    gap: clamp(6px, 2.2vw, 18px);
  }
  .zone { pointer-events: none; }
  .zone > * { pointer-events: auto; }
  .zone-left   { grid-column: 1; grid-row: 2; display:flex; justify-content:flex-start; }
  .zone-center { grid-column: 2; grid-row: 2; display:flex; flex-direction:column; align-items:center; gap: var(--gap); }
  .zone-right  { grid-column: 3; grid-row: 2; display:flex; justify-content:flex-end; }

  /* ===== D-PAD (visible cross) ===== */
  .dpad { width: var(--dpad); height: var(--dpad); position: relative; touch-action: none; user-select:none; }
  .dpad svg { width: 100%; height: 100%; display: block; filter: drop-shadow(0 12px 14px rgba(0,0,0,.5)); }
  .d-btn { position:absolute; border:none; background:transparent; outline:none; }
  .d-btn.up    { left: 32%; right: 32%; top: 0;    height: 40%; }
  .d-btn.down  { left: 32%; right: 32%; bottom: 0; height: 40%; }
  .d-btn.left  { top: 32%; bottom: 32%; left: 0;    width: 40%; }
  .d-btn.right { top: 32%; bottom: 32%; right: 0;   width: 40%; }
  .dpad.pressing-up    .arm-up,
  .dpad.pressing-down  .arm-down,
  .dpad.pressing-left  .arm-left,
  .dpad.pressing-right .arm-right { filter: brightness(1.2); }
  .d-btn:active { filter: brightness(1.1); transform: scale(1.05); }

  /* ===== START / SELECT + COLLAPSE ===== */
  .slab { display:flex; gap: calc(var(--gap) * 1.2); align-items:center; justify-content:center; }

  /*
    Minimalist-but-interesting pills: an elongated octagon inset (echoes the D-pad arm geometry),
    with etched ring and shine. Pure CSS; easy to tweak.
  */
  .pill {
    --bg: linear-gradient(#f3f3f3, var(--metal2));
    position: relative;
    width: var(--pill-w); height: var(--pill-h);
    border: none; border-radius: 999px;
    background: var(--bg);
    box-shadow: var(--shadow-outer), inset 0 1px 0 rgba(255,255,255,.6);
    font: 800 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#222; letter-spacing: .8px; text-transform: uppercase;
    touch-action: none; user-select:none;
    overflow: hidden;
  }
  /* inner elongated-octagon echo */
  .pill::before {
      content: "";
      position: absolute;
      inset: 5% 5%;
      background: var(--inset-fill);
      clip-path: polygon(8% 0, 92% 0, 100% 20%, 100% 80%, 92% 100%, 8% 100%, 0 80%, 0 20%);
      box-shadow: inset 0 0 0 2px var(--inset-stroke), inset 0 4px 8px rgba(0, 0, 0, .25), 0 1px 0 var(--inset-glow);
      border-radius: 35%;
  }
  .pill::after{
    content:""; position:absolute; inset:0; background: var(--shine);
    mix-blend-mode: screen; opacity:.35; pointer-events:none;
  }
  .pill:active { transform: translateY(2px); filter: brightness(1.05); box-shadow: var(--shadow-press); }

  /* Small circular collapse button (unchanged look, but harmonize with new badges) */
  .circle-btn {
    width: 44px; height: 44px; border-radius: 50%;
    border: solid 2px white; background:transparent;
    box-shadow: var(--shadow-press);
    display:flex; align-items:center; justify-content:center;
    font: 900 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:white; touch-action: none; user-select:none;
  }
  .circle-btn:active { transform: translateY(2px); filter: brightness(1.06); }

  /* ===== FACE BUTTONS ===== */
  .face { display:grid; align-items:end; justify-items:end; grid-template-columns: auto; grid-template-rows: auto auto; gap: var(--gap); padding-right: var(--pad); }
  .cluster { position: relative; width: calc(var(--btn-lg) * 2.2); height: calc(var(--btn-lg) * 1.5); }

  /*
    Minimalist-but-interesting bubbles: circular shell with an internal octagon echo.
    Each has a subtle etched ring + shine; labels are embossed.
  */
  .bubble {
    position:absolute; width: var(--btn-lg); height: var(--btn-lg);
    border-radius: 50%; border: none; outline:none;
    background: radial-gradient(180% 140% at 30% 24%, rgba(255,255,255,.55) 0, rgba(255,255,255,0) 38%), var(--red1);
    box-shadow: var(--shadow-outer), inset 0 2px 0 rgba(255,255,255,.45);
    color:#111; font: 900 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    text-shadow: 0 1px 0 rgba(255,255,255,.45);
    touch-action: none; user-select:none; overflow:hidden;
  }
  /* inner octagon echo */
  .bubble::before {
      content: "";
      position: absolute;
      inset: 3%;
      background: var(--inset-fill);
      clip-path: polygon(30% 0, 70% 0, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0 70%, 0 30%);
      box-shadow: inset 0 0 0 2px var(--inset-stroke), inset 0 6px 10px rgba(0, 0, 0, .25), 0 1px 0 var(--inset-glow);
      border-radius: 50%;
  }
  .bubble.b { left: 0; bottom: 0; }
  .bubble.a { right: 0; bottom: 0; }

  .bubble.dd{
    top: -40%; right: 0; width: var(--btn); height: var(--btn); font-weight: 800;
    background: radial-gradient(180% 140% at 30% 24%, rgba(255,255,255,.55) 0, rgba(255,255,255,0) 38%), var(--blue1);
  }

  .bubble:active { transform: translateY(2px); background: var(--red2); box-shadow: var(--shadow-press); }
  .bubble.dd:active{ background: var(--blue2); box-shadow: var(--shadow-press); }

  /* Embossed/etched badge text */
  .badge {
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    color: rgba(0,0,0,.76); font-weight:900; font-size: 18px; letter-spacing:.5px; pointer-events:none;
    text-shadow: 0 1px 0 rgba(255,255,255,.45), 0 -1px 0 rgba(0,0,0,.1);
  }

  @media (max-width: 900px) { :root { --scale: .95; } }
  @media (max-width: 780px) { :root { --scale: .85; } }
  @media (max-width: 640px) { :root { --scale: .78; } }
  @media (max-width: 520px) { :root { --scale: .72; } }

  .dpad-joy { position: absolute; inset: 0; z-index: 9; touch-action: none; user-select: none; background: transparent; }
</style>
</head>
<body>

<!-- FAB -->
<button class="fab" id="fabToggle" aria-label="Enable mobile controls">MOBILE</button>

<!-- Transparent Controller Overlay (hidden on load) -->
<div id="controller" class="controller" hidden aria-hidden="true">
  <!-- LEFT: D-PAD -->
  <div class="zone zone-left">
    <div class="dpad" id="dpad" aria-label="D-Pad" role="group">
      <!-- Visible cross -->
      <svg viewBox="0 0 200 200" aria-hidden="true">
        <!-- center hub -->
        <circle cx="100" cy="100" r="24" fill="#0f0f0f"/>
        <circle cx="100" cy="100" r="18" fill="#1a1a1a"/>

        <!-- UP (octagon, 3-layer) -->
        <g class="arm-up">
          <polygon fill="#1b1b1b" points="87,15 113,15 125,27 125,73 113,85 87,85 75,73 75,27" />
          <polygon fill="#2a2a2a" points="88,18 112,18 122,28 122,72 112,82 88,82 78,72 78,28" />
          <polygon fill="#171717" points="91,22 109,22 118,31 118,69 109,78 91,78 82,69 82,31" />
        </g>

        <!-- DOWN -->
        <g class="arm-down">
          <polygon fill="#1b1b1b" points="87,115 113,115 125,127 125,173 113,185 87,185 75,173 75,127" />
          <polygon fill="#2a2a2a" points="88,118 112,118 122,128 122,172 112,182 88,182 78,172 78,128" />
          <polygon fill="#171717" points="91,122 109,122 118,131 118,169 109,178 91,178 82,169 82,131" />
        </g>

        <!-- LEFT -->
        <g class="arm-left">
          <polygon fill="#1b1b1b" points="27,75 73,75 85,87 85,113 73,125 27,125 15,113 15,87" />
          <polygon fill="#2a2a2a" points="28,78 72,78 82,88 82,112 72,122 28,122 18,112 18,88" />
          <polygon fill="#171717" points="31,82 69,82 78,91 78,109 69,118 31,118 22,109 22,91" />
        </g>

        <!-- RIGHT -->
        <g class="arm-right">
          <polygon fill="#1b1b1b" points="127,75 173,75 185,87 185,113 173,125 127,125 115,113 115,87" />
          <polygon fill="#2a2a2a" points="128,78 172,78 182,88 182,112 172,122 128,122 118,112 118,88" />
          <polygon fill="#171717" points="131,82 169,82 178,91 178,109 169,118 131,118 122,109 122,91" />
        </g>
      </svg>

      <!-- Hit areas -->
      <button class="d-btn up"    data-key="ArrowUp"    data-code="ArrowUp"    aria-label="Up"></button>
      <button class="d-btn down"  data-key="ArrowDown"  data-code="ArrowDown"  aria-label="Down"></button>
      <button class="d-btn left"  data-key="ArrowLeft"  data-code="ArrowLeft"  aria-label="Left"></button>
      <button class="d-btn right" data-key="ArrowRight" aria-label="Right" data-code="ArrowRight"></button>
      <div class="dpad-joy" id="dpadJoy" aria-hidden="true"></div>
    </div>
  </div>

  <!-- CENTER: SELECT – COLLAPSE – START -->
  <div class="zone zone-center">
    <div class="slab">
      <button class="pill" data-key="Escape"  data-code="Escape"  aria-label="Select">SELECT</button>
      <button class="circle-btn" id="collapseBtn" aria-label="Hide controls" title="Hide">⤺</button>
      <button class="pill" data-key="Enter" data-code="Enter" aria-label="Start">START</button>
    </div>
  </div>

  <!-- RIGHT: FACE CLUSTER (B A + DD) -->
  <div class="zone zone-right">
    <div class="face">
      <div class="cluster" aria-label="Face Buttons" role="group">
        <button class="bubble b"  data-key=" " data-code="Space" aria-label="B (Space)"><span class="badge">B</span></button>
        <button class="bubble a"  data-key="x" data-code="KeyX" aria-label="A (X)"><span class="badge">A</span></button>
        <button class="bubble dd" data-key="z" data-code="KeyZ" aria-label="DD (Z)"><span class="badge">DD</span></button>
      </div>
    </div>
  </div>
</div>

<script>
/* Retro Mobile Controller - NES-style layout with show/hide logic
   Keys:
     Arrows, Enter(SELECT), Escape(START), Space(B), X(A), Z(DD)
*/
(function(){
  const $  = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const fab = $('#fabToggle');
  const overlay = $('#controller');
  const dpad = $('#dpad');
  const collapseBtn = $('#collapseBtn');
  const dpadJoy = $('#dpadJoy');
  const joyDirsPressed = new Set();
  let joyActivePointerId = null;

  function centerOf(el){
    const r = el.getBoundingClientRect();
    return { cx: r.left + r.width/2, cy: r.top + r.height/2, w: r.width, h: r.height };
  }

  function computeDirs(x, y, el){
    const { cx, cy, w, h } = centerOf(el);
    const dx = x - cx;
    const dy = y - cy;
    const rx = dx / (w * 0.5);
    const ry = dy / (h * 0.5);
    const dead = 0.15;
    const dirs = [];
    if (Math.abs(rx) > dead) { dirs.push(rx < 0 ? 'ArrowLeft' : 'ArrowRight'); }
    if (Math.abs(ry) > dead) { dirs.push(ry < 0 ? 'ArrowUp'   : 'ArrowDown'); }
    return new Set(dirs);
  }

  function setDpadVisual(dirs){
    dpad.classList.toggle('pressing-up',    dirs.has('ArrowUp'));
    dpad.classList.toggle('pressing-down',  dirs.has('ArrowDown'));
    dpad.classList.toggle('pressing-left',  dirs.has('ArrowLeft'));
    dpad.classList.toggle('pressing-right', dirs.has('ArrowRight'));
  }

  function syncJoyKeys(next){
    for (const key of joyDirsPressed) {
      if (!next.has(key)) { emitKey('keyup', key, key); }
    }
    for (const key of next) {
      if (!joyDirsPressed.has(key)) { emitKey('keydown', key, key); }
    }
    joyDirsPressed.clear();
    next.forEach(k => joyDirsPressed.add(k));
    setDpadVisual(joyDirsPressed);
  }

  function endJoy(){
    if (joyDirsPressed.size){
      for (const key of Array.from(joyDirsPressed)) emitKey('keyup', key, key);
      joyDirsPressed.clear();
      setDpadVisual(joyDirsPressed);
    }
    joyActivePointerId = null;
  }

  dpadJoy.addEventListener('pointerdown', (e) => {
    if (joyActivePointerId !== null) return; // single-finger joystick
    e.preventDefault();
    joyActivePointerId = e.pointerId;
    dpadJoy.setPointerCapture?.(e.pointerId);
    const next = computeDirs(e.clientX, e.clientY, dpadJoy);
    syncJoyKeys(next);
  });

  dpadJoy.addEventListener('pointermove', (e) => {
    if (e.pointerId !== joyActivePointerId) return;
    e.preventDefault();
    const next = computeDirs(e.clientX, e.clientY, dpadJoy);
    syncJoyKeys(next);
  });

  dpadJoy.addEventListener('pointerup', (e) => {
    if (e.pointerId !== joyActivePointerId) return;
    e.preventDefault();
    endJoy();
    try { dpadJoy.releasePointerCapture(e.pointerId); } catch {}
  });
  dpadJoy.addEventListener('pointercancel', (e) => {
    if (e.pointerId !== joyActivePointerId) return;
    e.preventDefault();
    endJoy();
    try { dpadJoy.releasePointerCapture(e.pointerId); } catch {}
  });

  const _oldReleaseAll = releaseAll;
  releaseAll = function(){ endJoy(); _oldReleaseAll(); };

  function focusGame() {
    const target = document.querySelector('[data-game-focus], canvas, [tabindex]');
    if (target && target.focus) target.focus({preventScroll:true});
  }

  function emitKey(type, key, code) {
    const target = (document.activeElement && document.activeElement !== document.body)
      ? document.activeElement : window;
    const ev = new KeyboardEvent(type, { key, code, bubbles:true, cancelable:true, repeat:false });
    const codeMap = {'ArrowUp':38,'ArrowDown':40,'ArrowLeft':37,'ArrowRight':39,'Escape':27,'Enter':13,' ':32,'x':88,'X':88,'z':90,'Z':90};
    Object.defineProperty(ev, 'keyCode', { get: () => codeMap[key] ?? codeMap[code] ?? 0 });
    Object.defineProperty(ev, 'which',   { get: () => codeMap[key] ?? codeMap[code] ?? 0 });
    target.dispatchEvent(ev);
  }

  const pressed = new Set();
  function press(el){
    const key  = el.getAttribute('data-key');
    const code = el.getAttribute('data-code');
    const id = code + '::' + key;
    if (!pressed.has(id)){
      pressed.add(id);
      emitKey('keydown', key, code);
      if (el.classList.contains('up'))    dpad.classList.add('pressing-up');
      if (el.classList.contains('down'))  dpad.classList.add('pressing-down');
      if (el.classList.contains('left'))  dpad.classList.add('pressing-left');
      if (el.classList.contains('right')) dpad.classList.add('pressing-right');
    }
  }
  function release(el){
    const key  = el.getAttribute('data-key');
    const code = el.getAttribute('data-code');
    const id = code + '::' + key;
    if (pressed.has(id)){
      pressed.delete(id);
      emitKey('keyup', key, code);
      if (el.classList.contains('up'))    dpad.classList.remove('pressing-up');
      if (el.classList.contains('down'))  dpad.classList.remove('pressing-down');
      if (el.classList.contains('left'))  dpad.classList.remove('pressing-left');
      if (el.classList.contains('right')) dpad.classList.remove('pressing-right');
      setDpadVisual(joyDirsPressed);
    }
  }
  function releaseAll(){
    $$('.d-btn, .pill, .bubble', overlay).forEach(release);
    pressed.clear();
    dpad.classList.remove('pressing-up','pressing-down','pressing-left','pressing-right');
  }

  function showOverlay(){
    fab.hidden = true; overlay.hidden = false; overlay.setAttribute('aria-hidden','false'); focusGame();
  }
  function hideOverlay(){
    releaseAll(); overlay.hidden = true; overlay.setAttribute('aria-hidden','true'); fab.hidden = false;
  }

  fab.addEventListener('click', showOverlay, {passive:true});
  collapseBtn.addEventListener('click', hideOverlay, {passive:true});

  function attachPressable(btn){
    btn.addEventListener('pointerdown', (e)=>{ if (e.pointerType === 'mouse' && e.button !== 0) return; e.preventDefault(); btn.setPointerCapture?.(e.pointerId); press(btn); });
    btn.addEventListener('pointerup',   (e)=>{ if (e.pointerType === 'mouse' && e.button !== 0) return; e.preventDefault(); release(btn); try{ btn.releasePointerCapture(e.pointerId); }catch{} });
    btn.addEventListener('pointercancel',(e)=>{ e.preventDefault(); release(btn); try{ btn.releasePointerCapture(e.pointerId);}catch{} });
    btn.addEventListener('pointerout', ()=> release(btn));
    btn.addEventListener('mousedown', (e)=>{ if (e.button!==0) return; e.preventDefault(); press(btn); });
    btn.addEventListener('mouseup',   (e)=>{ if (e.button!==0) return; e.preventDefault(); release(btn); });
    btn.addEventListener('mouseleave', ()=> release(btn));
  }

  $$('.d-btn, .pill, .bubble', overlay).forEach(attachPressable);

  overlay.addEventListener('touchmove', (e)=>{
    if (e.target.closest('.d-btn, .pill, .bubble')) e.preventDefault();
  }, {passive:false});

  window.addEventListener('blur', releaseAll);
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden) releaseAll(); });
  window.addEventListener('load', ()=>{ overlay.hidden = true; fab.hidden = false; });
})();
</script>
</body>
</html>
